# Универсальный парсер связанных сущностей CRM

![](https://i.postimg.cc/h4mHp19m/image.png)


## Описание
Кастомное активити для бизнес-процессов Битрикс24, предназначенное для работы в рамках сделок (Deal). Активити позволяет получать список связанных контактов или компаний, принадлежащих текущей сделке, фильтровать их по заданным критериям и возвращать значения указанных полей в переменные бизнес-процесса.

## Назначение
*   Автоматизация обработки связанных сущностей в CRM.
*   Выборка контактов/компаний сделки по конкретным условиям (например, найти все контакты с определенным email или компанией из списка).
*   Гибкое формирование выходных данных (массив ID, строка значений, массив значений).

## Параметры настройки (Свойства активити)

| Параметр | Код | Тип | Описание |
| :--- | :--- | :--- | :--- |
| **Кого ищем** | `TargetEntityType` | Список | Тип связанной сущности: `CONTACT` (Контакты) или `COMPANY` (Компании). |
| **Поле для возврата** | `ReturnField` | Список | Поле CRM, значение которого будет сохранено в результат (например, `NAME`, `PHONE`, `UF_DEPARTMENT`). |
| **Только основной** | `PrimaryOnly` | Флаг (Y/N) | Актуально для мультиполей (Email, Телефон). Если `Y`, возвращается только первое значение. |
| **Логика фильтров** | `FilterLogicGlobal` | Список | Глобальная логика условий: `AND` (Все условия) или `OR` (Любое условие). |
| **Фильтры** | `FilterFields` | Массив | Список полей для фильтрации. |
| **Условия** | `FilterLogics` | Массив | Операторы сравнения для каждого поля (EQ, CONT и т.д.). |
| **Значения** | `FilterValues` | Массив | Искомые значения для фильтрации. |

> **Примечание:** Список доступных полей формируется динамически. Включает стандартные поля CRM, пользовательские поля (UF_) и мультиполя (EMAIL, PHONE, WEB, IM).

## Возвращаемые значения (Переменные БП)

Активити заполняет следующие переменные, доступные на следующих шагах бизнес-процесса:

| Переменная | Код | Тип | Описание |
| :--- | :--- | :--- | :--- |
| **Найденные значения (Массив)** | `ResultValues` | String (Multiple) | Массив значений выбранного поля `ReturnField` из отфильтрованных сущностей. |
| **Найденные значения (Строка)** | `ResultString` | String | Все найденные значения, объединенные через запятую. |
| **ID найденных сущностей** | `FoundIds` | Int (Multiple) | Массив ID отфильтрованных контактов или компаний. |
| **Количество найденных** | `FoundCount` | Int | Числовое количество сущностей, прошедших фильтр. |

## Доступные условия фильтрации

В настройках фильтров поддерживаются следующие операторы сравнения:

| Код | Описание | Пример |
| :--- | :--- | :--- |
| `EQ` | Равно | `EMAIL` равно `test@mail.ru` |
| `NE` | Не равно | `NAME` не равно `Иван` |
| `CONT` | Содержит | `NAME` содержит `ООО` |
| `NOT_CONT` | Не содержит | `PHONE` не содержит `+7` |
| `GT` | Больше | `BUDGET` больше `1000` |
| `LT` | Меньше | `BUDGET` меньше `5000` |
| `EMPTY` | Пусто | Поле не заполнено |
| `NOT_EMPTY` | Не пусто | Поле заполнено |
| `IN_LIST` | В списке | Значение входит в список (через запятую) |

## Особенности реализации

1.  **Работа с мультиполями:**
    *   Поля `EMAIL`, `PHONE`, `WEB`, `IM` обрабатываются особым образом.
    *   При фильтрации по ним значения всех типов (например, все телефоны контакта) склеиваются в строку для проверки условия.
    *   При возврате значения (`ReturnField`) можно выбрать опцию "Только основной", чтобы получить лишь первое значение.
2.  **Пользовательские поля (UF):**
    *   Активити автоматически подгружает мета-данные пользовательских полей для Контактов и Компаний.
    *   Поддерживаются типы: строка, список (enumeration), булево (boolean).
3.  **Права доступа:**
    *   Выборки выполняются с флагом `CHECK_PERMISSIONS => 'N'`, что позволяет получать данные даже если у текущего пользователя нет прав на чтение этих сущностей (требуется осторожность при настройке прав БП).
4.  **Зависимость от документа:**
    *   Активити ожидает, что запущено в контексте сделки. ID сделки извлекается из `$documentId[2]` (формат `DEAL_{ID}`). Если запущено в другом контексте, выполнение завершается без ошибок, но с пустым результатом.

## Пример использования

**Сценарий:** Найти все контакты сделки, у которых заполнен мобильный телефон, и отправить им SMS.

1.  Добавить активити **Парсер связанных сущностей (Универсальный)**.
2.  Настройки:
    *   **Кого ищем:** `Контакты`.
    *   **Поле для возврата:** `ID` (или `PHONE`, если нужно передать номер).
    *   **Фильтры:**
        *   Поле: `PHONE`, Условие: `NOT_EMPTY`, Значение: (пусто).
    *   **Логика:** `И`.
3.  В результате в переменную `{=Variable:FoundIds}` попадут ID контактов.
4.  Далее использовать цикл `ForEach` по переменной `FoundIds` для отправки сообщений.

## Реальный кейс использования
**Контекст**: Клиент - компания. Со стороны клиента участвуют несколько сотрудников с разными полномочиями и задачами.
<br>


**Задача**: Настроить автоматизированную отправку e-mail контактам с персонализировнным содержимы:
* Директор (ЛПР) - должен получать простые отбивки о статусе сделки;
* Ответственный - основной контакт, который должен быть информирован о всех дателях процесса;
* Бухгалтер - должен получать закрывающие документы

**Решение**: Сначала нужно настроить карточку контакта: нам необходимо поле типа "Должность" или "Роль". Любой тэг, чтобы человек мог понять, за что именно отвечает контакт.  
Далее настраиваем активити на сбор email адресов из контактов по ролям и настраиваем отправку сообщения на определенную роль.

## Установка
1.  Скачать папку `crmlinkedparser` целиком.
2.  Разместить ее в каталоге пользовательских активити  (стандартный путь: `.../bitrix/activities/custom`).
~~~
bitrix/ 
└── activities/ 
    ├── bitrix/
    └── custom/
        └── crmlinkedparser/  
            ├── crmlinkedparser.php 
            ├── properties_dialog.php  
            └── .description.php 
~~~
3.  Файлы:
    *   `crmlinkedparser.php` — основной класс логики.
    *   `properties_dialog.php` — шаблон окна настроек.
    *   `.description.php` — описание активити для системы.
4.  Очистить кеш через админ-панель (Настройки → Настройки продукта → Автокеширование → Очистка файлов кеша → Все).  
5.  В дизайнере бизнес процессов: раздел CRM - Парсер связанных сущностей (Универсальный)